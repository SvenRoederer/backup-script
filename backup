#!/bin/sh
#

CONF_FILE=/etc/backup-script/backup.conf
. $CONF_FILE

#######################
#
# don't modify atfer here
#
########################

export CONF_FILE
export CURRENT_BACKUP_DIR=$BACKUP_STORE/`date +%Y-%m-%d`
if [ -z $BACKUP_SCRIPTS_DIR ]; then
  BACKUP_SCRIPTS_DIR=`dirname $0`
  BACKUP_SCRIPTS_DIR=$BACKUP_SCRIPTS_DIR/tasks.d/
fi

#umask 007

mkdir_err=`mkdir 2>&1 $CURRENT_BACKUP_DIR`
if [ $? != 0 ]; then
  echo "Das Verzeichnis $CURRENT_BACKUP_DIR exsistiert bereits."
  echo "Kein Backup angelegt."
  echo "mkdir-Fehlermeldung:"
  echo $mkdir_err
  exit 1
fi

cd $CURRENT_BACKUP_DIR

run-parts --exit-on-error $BACKUP_SCRIPTS_DIR
if [ $? != 0 ]; then
    echo "Fehler beim ausfÃ¼hren der Backup-scripte!"
    exit 1
fi

chown -R backup.backup $CURRENT_BACKUP_DIR
chmod -R 660 $CURRENT_BACKUP_DIR
chmod 750 $CURRENT_BACKUP_DIR

#if [ -e $BACKUP_STORE/current ]; then
rm -f $BACKUP_STORE/current
#fi
ln -sf $CURRENT_BACKUP_DIR $BACKUP_STORE/current

# delete old backups
BACKUPS=`ls -d -1 $BACKUP_STORE/????-??-??`
NUM_BACKUPS=`echo "$BACKUPS"|wc -l`
if [ $NUM_BACKUPS -gt $HOLD_BACKUPS ]; then
  NUM_DIRS_TO_DEL=`echo "$NUM_BACKUPS-$HOLD_BACKUPS"|bc`
  DIRS_TO_DEL=`echo "$BACKUPS"|head -n $NUM_DIRS_TO_DEL -`
#  echo $NUM_DIRS_TO_DEL backups zu löschen
  rm -r $DIRS_TO_DEL
fi
